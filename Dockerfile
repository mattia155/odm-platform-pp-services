# Stage 1
FROM maven:3-openjdk-11-slim as build

WORKDIR /workspace/app

COPY pom.xml .
COPY src src
COPY scripts/redoc-static-html-gen.sh scripts/redoc-static-html-gen.sh

ARG SPRING_PROFILES_ACTIVE
ARG DATABASE_URL
ARG DATABASE_USERNAME
ARG DATABASE_PASSWORD
ARG SPRING_DATABASE_DIALECT
ARG SPRING_DATABASE_DRIVER
ARG FLYWAY_SCHEMA
ARG FLYWAY_SCRIPTS_DIR
ENV SPRING_PROFILES_ACTIVE ${SPRING_PROFILES_ACTIVE}
ENV DATABASE_URL ${DATABASE_URL}
ENV DATABASE_USERNAME ${DATABASE_USERNAME}
ENV DATABASE_PASSWORD ${DATABASE_PASSWORD}
ENV SPRING_DATABASE_DIALECT ${SPRING_DATABASE_DIALECT}
ENV SPRING_DATABASE_DRIVER ${SPRING_DATABASE_DRIVER}
ENV FLYWAY_SCHEMA ${FLYWAY_SCHEMA}
ENV FLYWAY_SCRIPTS_DIR ${FLYWAY_SCRIPTS_DIR}

RUN mvn clean install -DskipTests -Dactive.profile=$SPRING_PROFILES_ACTIVE

# Stage 2
FROM openjdk:11-jre-slim

RUN apt-get update && apt-get install -y wget gpg lsb-release zip curl

ARG APP_NAME
ARG SPRING_PROFILES_ACTIVE
ARG JAVA_OPTS
ARG DATABASE_URL
ARG DATABASE_USERNAME
ARG DATABASE_PASSWORD
ARG SPRING_DATABASE_DIALECT
ARG SPRING_DATABASE_DRIVER
ARG FLYWAY_SCHEMA
ARG FLYWAY_SCRIPTS_DIR
ENV SPRING_PROFILES_ACTIVE ${SPRING_PROFILES_ACTIVE}
ENV APP_NAME ${APP_NAME}
ENV JAVA_OPTS ${JAVA_OPTS}
ENV DATABASE_URL ${DATABASE_URL}
ENV DATABASE_USERNAME ${DATABASE_USERNAME}
ENV DATABASE_PASSWORD ${DATABASE_PASSWORD}
ENV SPRING_DATABASE_DIALECT ${SPRING_DATABASE_DIALECT}
ENV SPRING_DATABASE_DRIVER ${SPRING_DATABASE_DRIVER}
ENV FLYWAY_SCHEMA ${FLYWAY_SCHEMA}
ENV FLYWAY_SCRIPTS_DIR ${FLYWAY_SCRIPTS_DIR}

COPY --from=build  /workspace/app/target/$APP_NAME-*.jar /app/

RUN ln -s -f /usr/share/zoneinfo/Europe/Rome /etc/localtime

CMD java $JAVA_OPTS -jar /app/$APP_NAME-*.jar --spring.profiles.active=$SPRING_PROFILES_ACTIVE